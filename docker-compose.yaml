# networks:
#   default:
#     external: true
#     name: traefik-proxy

services:
  nginx:
    image: nginx:latest
    restart: unless-stopped
    ports:
      - ${PORT:-8080}:80
    volumes:
      - ./docker/nginx/:/etc/nginx/conf.d/

  frontend:
    image: mivalsten/gig3r-frontend:${GIGER_IMAGE_TAG:-latest}
    build:
      context: ./frontend
    restart: unless-stopped
    expose:
      - 8080

  backend:
    image: mivalsten/gig3r-backend:${GIGER_IMAGE_TAG:-latest}
    build:
      context: ./backendDotnet/Giger
      dockerfile: ../Dockerfile
      args:
        - ASPNETCORE_CONFIGURATION=Debug
    restart: unless-stopped
    expose:
      - 8080
    ports:
      - 9090:8080
    volumes:
      - ./backendDotnet/Giger/appsettings.json:/app/appsettings.json
    environment:
      #- GigerDB__ConnectionString=mongodb://mongo:27017
      - GigerDB__Host=mongo
      - GigerDB__Port=27017
      - GigerDB__Username=${GIGER_USERNAME:-giger}
      - GigerDB__Password=${GIGER_PASSWORD:-giger}
      - GigerDB__DatabaseName=${GIGER_DATABASE:-giger}
      - ASPNETCORE_ENVIRONMENT=Development
    depends_on:
      - mongo
  
  mongo:
    image: mongo:latest
    restart: unless-stopped
    expose:
      - 27017
    volumes:
      - ./docker/volumes/mongo:/data/db
      - ./docker/mongo_init:/docker-entrypoint-initdb.d
    environment:
      GIGER_DATABASE_NAME: ${GIGER_DATABASE:-giger}
      GIGER_USERNAME: ${GIGER_USERNAME:-giger}
      GIGER_PASSWORD: ${GIGER_PASSWORD:-giger}
      MONGO_INITDB_DATABASE: admin
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example

  mongo-express:
    image: mongo-express
    restart: unless-stopped
    ports:
      - 8081:8081
    environment:
      ME_CONFIG_MONGODB_SERVER: mongo
      ME_CONFIG_MONGODB_AUTH_DATABASE: admin
      ME_CONFIG_MONGODB_ADMINUSERNAME: root
      ME_CONFIG_MONGODB_ADMINPASSWORD: example
    depends_on:
      - mongo

  # swagger:
  #   image: swaggerapi/swagger-ui
  #   restart: unless-stopped
  #   ports:
  #     - ${SWAGGER_PORT:-8090}:8080
  #   volumes:
  #     - ./swagger.yml:/tmp/swagger.yml
  #   environment:
  #     SWAGGER_JSON: "/tmp/swagger.yml"
  #     BASE_URL: "/swagger"

  # backend:
  #   build:
  #     context: ./backend
  #   restart: unless-stopped
  #   expose:
  #     - 80
  #   volumes:
  #     - ./docker/backend/config.json:/app/.config.json
  #     - ./backend/migrations/:/app/migrations
  #   depends_on:
  #     - postgres

  # postgres:
  #   image: postgres:16-alpine
  #   environment:
  #     POSTGRES_PASSWORD: postgres
  #   volumes:
  #     - ./docker/volumes/postgres:/var/lib/postgresql/data/